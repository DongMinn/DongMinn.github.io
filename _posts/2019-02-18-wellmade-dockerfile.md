---
layout: post
title: "Dockerfile 잘 작성하기"
date: 2019-02-18
excerpt: "Dockerfile 잘 작성하기"
tags: [docker, dockerfile]
comments: true
---



# Dockerfile 잘 작성하기



### Dockerfile

- 일종의 이미지 설정파일이다.
- 생긴 모양은 쉘 스크립트와 유사하지만 자체의 문법을 가지고 있다. 이렇게 작성된 Dockerfile은 `build` 명령어를 통해 이미지를 생성할 수 있다.



#### .dockerignore를 활용하자

대부분의 경우 각 Dockerfile은 빈 디렉토리에 저장하는 것이 좋다. 그런 다음 빌드하는데 필요한 파일들만 해당 디렉토리에 추가하는게 좋다. 빌드의 성능을 높이려면 해당 디렉토리에 `.dockerignore` 를 추가하여 파일 및 디렉토리를 제외 하는것이 좋다.

`.gitignore` 파일과 유사하게 동작한다. 따라서 원하지 않는 파일 및 디렉토리를 제외시켜 이미지의 용량을 줄이자.



#### 불필요한 패키지는 설치하지 말자

이미지 크기를 줄이기 위해서는 당연하지만, 불필요한 패키지는 설치하지 않아야 한다. 
(ex: airflow이미지에 굳이 필요없는 다른 패키지들을 포함시키기)



#### 컨테이너는 오직 하나의 관심사만 

애플리케이션을 여러 컨테이너로 분리하면 컨테이너를 확장하고 재사용하는 것이 훨씬 쉬워진다. 개발할때, 함수로 잘 쪼개어 만들면 재사용하기 좋은것과 같은 이치이다.

다만 언제나 컨테이너 당 하나의 운영체제 프로세스만 있어야 하는것은 아니다. 일부 프로그램은 자체적으로 추가 프로세스를 생성할 수 있다.



#### 레이어의 수를 최소화하자

사용하는 레이어의 수에 대해 전략적이고 신중해야 한다. 장기적 관점에서 보았을 때 유지보수를 위해서는 레이어의 수를 최소화 하는 것이 현명한 선택이 될 수 있다. 



#### 줄바꿈을 사용하여 정렬하자 

```shell
RUN apt-get update && apt-get install -y \
	bzr \
	cvs \
	git
```

줄바꿈을 사용하면, 패키지의 중복을 피하고 목록을 훨씬 쉽게 업데이트 할 수 있다. 



#### 캐시를 활용하여 빌드하자

이미지를 작성하는 과정에서 Docker는 순차적으로 Dockerfile을 실행한다. 

각 명령을 실행할 때 Docker는 매번 새로운 이미지를 만드는 대신 캐시에서 기존 이미지를 찾아 재사용 할 수 있다. 캐시를 전혀 사용하지 않으려는 경우 docker 빌드 명령에서 `--no-cache = true` 옵션을 사용하면 된다. 

Docker가 캐시를 사용하게 하려면 일치하는 이미지를 찾을 때와 그렇지 않을 때를 이해하는 것이 매우 중요하다. Docker cache의 기본 규칙은 다음과 같다 

- 이미 캐시에 있는 기본 이미지로 시작하여 다음 명령어가 해당 기본 이미지에서 파생된 모든 하위 이미지와 비교되어 그 중 하나가 정확히 동일한 명령어를 사용하여 빌드되었는지 확인한다. 그렇지 않으면 캐시가 무효화 된다. 
- `ADD` `COPY` 명령을 제외하고 캐시 검사는 컨테이너의 파일을 보고 캐시 일치를 판별하지 않는다. 예를 들어 `RUN apt-get -y update` 명령을 처리 할 때 컨테이너에서 업데이트 된 파일은 캐시 히트가 있는지 여부를 확인하기 위해 검사되지 않는다. 이 경우 명령 문자열 자체만 일치하는지 확인한다. 
- 캐시가 무효화되면 이 후의 모든 Dockerfile 명령은 새로운 이미지를 생성하고 캐시는 사용되지 않는다.









*참고 사이트*
[https://docs.docker.com/develop/develop-images/dockerfile_best-practices/](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
